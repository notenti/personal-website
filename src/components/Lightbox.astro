---
interface Props {
  images: Array<{
    src: string;
    date?: Date;
    place?: string;
  }>;
}

const { images } = Astro.props;
---

<div id="lightbox" class="fixed inset-0 bg-white z-50 hidden" data-images={JSON.stringify(images)}>
  <!-- Minimal top bar -->
  <div class="absolute top-0 left-0 right-0 flex justify-between items-center p-4 z-20">
    <div id="lightbox-caption" class="text-stone-500 text-sm"></div>
    <button id="lightbox-close" class="text-stone-400 hover:text-stone-600 transition-colors p-2" aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>

  <!-- Navigation areas (invisible, full height) -->
  <button id="lightbox-prev" class="absolute left-0 top-0 bottom-0 w-1/3 z-10 cursor-w-resize opacity-0" aria-label="Previous"></button>
  <button id="lightbox-next" class="absolute right-0 top-0 bottom-0 w-1/3 z-10 cursor-e-resize opacity-0" aria-label="Next"></button>

  <!-- Image container -->
  <div class="absolute inset-0 flex items-center justify-center p-4 md:p-12">
    <img id="lightbox-img" class="max-h-full max-w-full object-contain" />
  </div>

  <!-- Bottom bar with counter and navigation hints -->
  <div class="absolute bottom-0 left-0 right-0 flex justify-center items-center p-4 z-20">
    <div class="flex items-center gap-6 text-stone-400 text-sm">
      <span id="lightbox-nav-hint" class="hidden md:block">← →</span>
      <span id="lightbox-counter" class="font-mono"></span>
    </div>
  </div>
</div>

<script is:inline>
(function() {
  var lightbox = document.getElementById('lightbox');
  var lightboxImg = document.getElementById('lightbox-img');
  var lightboxCaption = document.getElementById('lightbox-caption');
  var lightboxCounter = document.getElementById('lightbox-counter');
  var closeBtn = document.getElementById('lightbox-close');
  var prevBtn = document.getElementById('lightbox-prev');
  var nextBtn = document.getElementById('lightbox-next');

  var images = JSON.parse(lightbox.dataset.images || '[]');
  var currentIndex = 0;

  function getImageId(src) {
    var parts = src.split('/').pop();
    var filename = parts ? parts.split('.')[0] : '';
    return filename;
  }

  function formatDate(dateStr) {
    if (!dateStr) return '';
    var date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  function updateLightbox() {
    var image = images[currentIndex];
    lightboxImg.src = image.src;

    var parts = [];
    if (image.place) parts.push(image.place);
    if (image.date) parts.push(formatDate(image.date));
    lightboxCaption.textContent = parts.join(' · ');

    lightboxCounter.textContent = (currentIndex + 1) + ' / ' + images.length;

    var imageId = getImageId(image.src);
    history.replaceState(null, '', '#' + imageId);
  }

  function openLightbox(src) {
    // Normalize src - extract path from full URL if needed
    var srcPath = src;
    try {
      var url = new URL(src);
      srcPath = url.pathname;
    } catch(e) {
      // src is already a relative path
    }

    var index = -1;
    for (var i = 0; i < images.length; i++) {
      if (images[i].src === srcPath || images[i].src === src) {
        index = i;
        break;
      }
    }
    if (index !== -1) {
      currentIndex = index;
      updateLightbox();
      lightbox.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
  }

  function openLightboxByIndex(index) {
    if (index >= 0 && index < images.length) {
      currentIndex = index;
      updateLightbox();
      lightbox.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
  }

  function closeLightbox() {
    lightbox.classList.add('hidden');
    document.body.style.overflow = '';
    history.replaceState(null, '', window.location.pathname);
  }

  function showPrev() {
    currentIndex = (currentIndex - 1 + images.length) % images.length;
    updateLightbox();
  }

  function showNext() {
    currentIndex = (currentIndex + 1) % images.length;
    updateLightbox();
  }

  // Click handler using event delegation
  document.addEventListener('click', function(e) {
    var target = e.target;
    if (target && target.classList && target.classList.contains('lightbox-trigger')) {
      e.preventDefault();
      openLightbox(target.src);
    }
  });

  // Lightbox controls
  closeBtn.addEventListener('click', closeLightbox);
  prevBtn.addEventListener('click', function(e) { e.stopPropagation(); showPrev(); });
  nextBtn.addEventListener('click', function(e) { e.stopPropagation(); showNext(); });

  // Keyboard navigation
  document.addEventListener('keydown', function(e) {
    if (lightbox.classList.contains('hidden')) return;

    if (e.key === 'Escape') {
      closeLightbox();
    } else if (e.key === 'ArrowLeft') {
      showPrev();
    } else if (e.key === 'ArrowRight') {
      showNext();
    }
  });

  // Handle URL hash on page load
  function checkHash() {
    var hash = window.location.hash.slice(1);
    if (hash) {
      for (var i = 0; i < images.length; i++) {
        if (getImageId(images[i].src) === hash) {
          openLightboxByIndex(i);
          break;
        }
      }
    }
  }

  window.addEventListener('hashchange', checkHash);
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', checkHash);
  } else {
    checkHash();
  }

  // Expose for debugging
  window.openLightbox = openLightbox;
})();
</script>

<style>
  #lightbox img {
    transition: opacity 0.15s ease;
  }
</style>
