---
interface Image {
  src: string;
  date?: Date;
  place?: string;
}

interface Props {
  images: Image[];
  layout: string[];
}

const { images, layout } = Astro.props;

// Parse layout strings into structured rows
// e.g. 'half half' -> [{ size: 'half' }, { size: 'half' }]
const parseRow = (rowStr: string) => {
  return rowStr.trim().split(/\s+/).map(size => ({ size }));
};

// Build rows with images assigned
const buildRows = () => {
  const rows: { size: string; image: Image }[][] = [];
  let imageIndex = 0;

  for (const rowStr of layout) {
    const slots = parseRow(rowStr);
    const row: { size: string; image: Image }[] = [];

    for (const slot of slots) {
      if (imageIndex < images.length) {
        row.push({ size: slot.size, image: images[imageIndex] });
        imageIndex++;
      }
    }

    if (row.length > 0) {
      rows.push(row);
    }
  }

  // If there are remaining images after layout is exhausted, add them as full-width
  while (imageIndex < images.length) {
    rows.push([{ size: 'full', image: images[imageIndex] }]);
    imageIndex++;
  }

  return rows;
};

const rows = buildRows();

// Map size to grid column span (12-column grid)
const sizeToSpan: Record<string, string> = {
  'full': 'col-span-12',
  'half': 'col-span-12 sm:col-span-6',
  'third': 'col-span-12 sm:col-span-4',
  'two-thirds': 'col-span-12 sm:col-span-8',
  'quarter': 'col-span-6 sm:col-span-3',
  'three-quarters': 'col-span-12 sm:col-span-9',
};

const formatDate = (date: Date) => {
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
};
---

<div class="photo-layout">
  {rows.map((row, rowIndex) => (
    <div class="grid grid-cols-12 gap-2" data-row={rowIndex}>
      {row.map(({ size, image }) => (
        <figure class={`${sizeToSpan[size] || sizeToSpan['full']} m-0`}>
          <img
            src={image.src}
            alt=""
            class="w-full h-full object-cover rounded-sm lightbox-trigger cursor-zoom-in hover:opacity-95 transition-opacity"
            loading="lazy"
          />
          {(image.place || image.date) && (
            <figcaption class="text-center text-xs text-stone-400 mt-1.5 tracking-wide">
              {[image.place, image.date && formatDate(image.date)].filter(Boolean).join(' Â· ')}
            </figcaption>
          )}
        </figure>
      ))}
    </div>
  ))}
</div>

<style>
  .photo-layout {
    @apply space-y-2;
  }

  .photo-layout figure {
    @apply overflow-hidden;
  }

  .photo-layout img {
    @apply aspect-[4/3];
  }

  /* Allow full-width images to be taller */
  .photo-layout [data-row] figure:only-child img {
    @apply aspect-[3/2];
  }
</style>
