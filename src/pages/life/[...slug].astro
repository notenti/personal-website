---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Lightbox from '../../components/Lightbox.astro';
import PhotoLayout from '../../components/PhotoLayout.astro';
import AlbumMap from '../../components/AlbumMap.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const albums = await getCollection('albums');
  return albums.map((album) => ({
    params: { slug: album.slug },
    props: { album, allAlbums: albums },
  }));
}

const { album, allAlbums } = Astro.props;

// Get other albums for sidebar (excluding current, sorted by date)
const otherAlbums = allAlbums
  .filter((a: any) => a.slug !== album.slug)
  .sort((a: any, b: any) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 5);

const formatDate = (date: Date) => {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
  });
};

const formatShortDate = (date: Date) => {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
  });
};

// Default layout if none specified: all images full-width
const defaultLayout = album.data.images.map(() => 'full');
const layout = album.data.layout || defaultLayout;
---

<BaseLayout title={`${album.data.title} - Nate Otenti`} description={album.data.description}>
  <main class="min-h-screen p-8">
    <div class="max-w-7xl mx-auto p-8">
      <div class="flex flex-col lg:flex-row lg:gap-16">
        <!-- Main content -->
        <article class="flex-1 max-w-4xl">
          <a href="/life" class="font-mono text-sm text-stone-400 hover:text-accent mb-8 inline-block">&larr; life</a>

          <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-semibold text-stone-900 mb-3">{album.data.title}</h1>
            <div class="flex flex-wrap items-center gap-3 text-sm text-stone-500">
              <time class="font-mono">{formatDate(album.data.date)}</time>
              {album.data.location && (
                <>
                  <span class="text-stone-300">·</span>
                  <span>{album.data.location}</span>
                </>
              )}
              <span class="text-stone-300">·</span>
              <span>{album.data.images.length} photos</span>
            </div>
          </header>

          {album.data.blurb && (
            <p class="text-lg text-stone-600 leading-relaxed mb-10 max-w-2xl">
              {album.data.blurb}
            </p>
          )}

          <PhotoLayout images={album.data.images} layout={layout} />

          <AlbumMap images={album.data.images} />
        </article>

        <!-- Sidebar -->
        {otherAlbums.length > 0 && (
          <aside class="hidden lg:block w-56 flex-shrink-0">
            <div class="sticky top-8">
              <h2 class="text-sm font-medium text-stone-400 mb-4 uppercase tracking-wider">More Albums</h2>
              <nav class="space-y-4">
                {otherAlbums.map((a: any) => (
                  <a href={`/life/${a.slug}`} class="block group">
                    <span class="text-stone-700 group-hover:text-accent transition-colors text-sm font-medium">
                      {a.data.title}
                    </span>
                    <span class="block text-xs text-stone-400 mt-0.5 font-mono">
                      {formatShortDate(a.data.date)}
                    </span>
                  </a>
                ))}
              </nav>
            </div>
          </aside>
        )}
      </div>
    </div>
  </main>

  <Lightbox images={album.data.images} />
</BaseLayout>

